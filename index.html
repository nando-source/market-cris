<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MiniMarket Cris - Sistema Enterprise Dyzav</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #FF6B35; --secondary: #2C3E50; --success: #27AE60; --danger: #E74C3C;
            --light: #F8F9FA; --dark: #2C3E50;
            --gradient: linear-gradient(135deg, #FF6B35 0%, #F7C59F 100%);
            --ai-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: #f0f2f5; color: var(--dark); padding-bottom: 80px; }

        /* UI BASE */
        .top-bar { position: fixed; top:0; left:0; right:0; background: #003366; color:white; padding:0.5rem 1rem; z-index:1000; font-size:0.9rem; display:flex; justify-content:space-between; }
        .app-layout { display: flex; padding-top: 40px; min-height: 100vh; }
        
        /* SIDEBAR */
        .sidebar { width: 260px; background: white; height: 100vh; position: fixed; top: 40px; left: 0; box-shadow: 2px 0 10px rgba(0,0,0,0.05); z-index: 900; overflow-y: auto; }
        .sidebar-header { padding: 2rem; background: var(--gradient); color: white; }
        .nav-item { padding: 1rem 1.5rem; cursor: pointer; display: flex; gap: 10px; color: #555; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: #fff5f0; color: var(--primary); border-left: 4px solid var(--primary); font-weight: 600; }

        /* MAIN CONTENT */
        .main-content { margin-left: 260px; flex: 1; padding: 2rem; width: 100%; }
        
        /* CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .card { background: white; padding: 1.5rem; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); margin-bottom: 1.5rem; }
        .stat-val { font-size: 1.8rem; font-weight: 700; margin: 0.5rem 0; color: var(--secondary); }
        .chart-box { position: relative; height: 300px; width: 100%; }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th { text-align: left; padding: 1rem; background: #f8f9fa; color: #666; font-size: 0.85rem; }
        td { padding: 1rem; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .badge { padding: 4px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 600; }
        .bg-green { background: #d4edda; color: #155724; }
        .bg-red { background: #f8d7da; color: #721c24; }

        /* MOBILE */
        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); transition: 0.3s; }
            .sidebar.show { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 1rem; }
            .mobile-btn { display: block; }
        }
        .mobile-btn { display: none; background: none; border: none; font-size: 1.5rem; color: white; cursor: pointer; }

        /* CHATBOT */
        .chat-widget { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--ai-gradient); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; cursor: pointer; z-index: 2000; box-shadow: 0 5px 20px rgba(100,100,255,0.3); }
        .chat-window { position: fixed; bottom: 90px; right: 20px; width: 350px; height: 500px; background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: none; flex-direction: column; z-index: 2000; overflow: hidden; }
        .chat-body { flex: 1; padding: 1rem; overflow-y: auto; background: #f4f7f6; }
        .msg { padding: 10px 15px; border-radius: 15px; margin-bottom: 10px; max-width: 80%; font-size: 0.9rem; }
        .msg.bot { background: white; align-self: flex-start; border: 1px solid #eee; }
        .msg.user { background: var(--primary); color: white; align-self: flex-end; margin-left: auto; }

        /* UTILS */
        .btn { padding: 0.6rem 1.2rem; border: none; border-radius: 8px; cursor: pointer; background: var(--gradient); color: white; font-weight: 500; }
        .hidden { display: none; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 8px; width: 100%; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div style="display:flex; gap:10px; align-items:center;">
            <button class="mobile-btn" onclick="toggleMenu()">â˜°</button>
            <strong>MiniMarket Cris</strong>
        </div>
        <div>Tasa BCV: <strong id="bcvRate">Bs. 378,46</strong></div>
    </div>

    <div class="app-layout">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Panel Dyzav</h2>
                <p>Admin: Crisbel</p>
            </div>
            <div onclick="show('dashboard')" class="nav-item active">ðŸ“Š Dashboard</div>
            <div onclick="show('inventory')" class="nav-item">ðŸ“¦ Inventario</div>
            <div onclick="show('sales')" class="nav-item">ðŸ’° Punto de Venta</div>
            <div onclick="show('profits')" class="nav-item">ðŸ“ˆ Ganancias</div>
            <div onclick="show('fiscal')" class="nav-item">ðŸ“š Libros Fiscales</div>
        </div>

        <div class="main-content">
            
            <div id="dashboard" class="page">
                <h2 style="margin-bottom:1.5rem">Resumen General</h2>
                <div class="stats-grid">
                    <div class="card">
                        <small>Ventas Totales (Mes)</small>
                        <div class="stat-val" id="totalSales">Bs. 0,00</div>
                        <small class="bg-green badge">â†‘ 12% vs mes anterior</small>
                    </div>
                    <div class="card">
                        <small>Ganancia Neta</small>
                        <div class="stat-val" id="totalProfit" style="color:var(--success)">Bs. 0,00</div>
                    </div>
                    <div class="card">
                        <small>Total Transacciones</small>
                        <div class="stat-val" id="totalTx">0</div>
                    </div>
                </div>
                <div class="card">
                    <h3>Tendencia de Ventas (Ãšltimos 30 dÃ­as)</h3>
                    <div class="chart-box"><canvas id="salesChart"></canvas></div>
                </div>
            </div>

            <div id="inventory" class="page hidden">
                <div style="display:flex; justify-content:space-between; margin-bottom:1rem">
                    <h2>Inventario</h2>
                    <button class="btn" onclick="alert('FunciÃ³n de agregar en mantenimiento')">+ Nuevo Producto</button>
                </div>
                <div class="card">
                    <table id="invTable">
                        <thead><tr><th>Producto</th><th>Stock</th><th>Costo</th><th>Precio</th><th>AcciÃ³n</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="sales" class="page hidden">
                <h2>Punto de Venta</h2>
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap: 2rem; margin-top:1rem">
                    <div class="card">
                        <input type="text" id="posSearch" placeholder="Buscar producto (ej: harina)..." onkeyup="filterPos()">
                        <div style="margin-top:1rem; max-height:400px; overflow-y:auto">
                            <table id="posTable">
                                <thead><tr><th>Producto</th><th>Precio</th><th></th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card" style="background:#fff5f0">
                        <h3>Carrito</h3>
                        <table id="cartTable"><tbody></tbody></table>
                        <hr style="margin:1rem 0; border:0; border-top:1px dashed #ccc">
                        <div style="display:flex; justify-content:space-between; font-size:1.2rem; font-weight:bold">
                            <span>Total:</span>
                            <span id="cartTotal">Bs. 0,00</span>
                        </div>
                        <button class="btn" style="width:100%; margin-top:1rem" onclick="checkout()">COBRAR</button>
                    </div>
                </div>
            </div>

            <div id="profits" class="page hidden">
                <h2>Reporte de Ganancias</h2>
                <div class="card">
                    <div class="chart-box"><canvas id="profitChart"></canvas></div>
                </div>
                <div class="card">
                    <h3>Detalle por Producto</h3>
                    <table id="profitTable">
                        <thead><tr><th>Producto</th><th>Vendidos</th><th>Ingresos</th><th>Ganancia</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="fiscal" class="page hidden">
                <h2>Libros Fiscales (SENIAT)</h2>
                <div class="card">
                    <div style="margin-bottom:1rem">
                        <button class="badge bg-green" style="border:none; cursor:pointer; font-size:1rem; padding:10px">Descargar Excel</button>
                    </div>
                    <table id="fiscalTable">
                        <thead><tr><th>Fecha</th><th>Factura</th><th>Control</th><th>Cliente</th><th>Total Bs</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <div class="chat-widget" onclick="toggleChat()">ðŸ¤–</div>
    <div class="chat-window" id="chatWindow">
        <div style="padding:1rem; background:var(--ai-gradient); color:white; font-weight:bold; display:flex; justify-content:space-between">
            <span>Asistente Cris AI (2.5)</span>
            <span onclick="toggleChat()" style="cursor:pointer">x</span>
        </div>
        <div class="chat-body" id="chatBody">
            <div class="msg bot">Â¡Hola Crisbel! Soy tu asistente potenciado por Gemini 2.5. Â¿En quÃ© te ayudo hoy con el negocio?</div>
        </div>
        <div style="padding:10px; border-top:1px solid #eee; display:flex; gap:5px">
            <input type="text" id="chatInput" placeholder="Pregunta algo...">
            <button class="btn" onclick="sendMsg()">âž¤</button>
        </div>
    </div>

    <script>
        // CONFIG
        const BCV = 378.46;
        const API_KEY = 'AIzaSyAj-nK6iC2Yb656r2mul8FoclOwiYzJvv8';
        const MODEL = 'gemini-2.5-flash';

        // DATABASE (NUEVAS KEYS PARA FORZAR REINICIO)
        const DB = {
            prods: 'dyzav_final_products',
            sales: 'dyzav_final_sales',
            fiscal: 'dyzav_final_fiscal'
        };

        // ESTADO
        let products = [];
        let sales = [];
        let fiscal = [];
        let cart = [];
        let salesChart, profitChart;

        // --- 1. GENERADOR DE DATOS MASIVO ---
        function initData() {
            // Verificar si existen datos, si no, crear masivamente
            if (!localStorage.getItem(DB.sales)) {
                console.log("Generando datos Dyzav...");
                
                // Productos Base
                products = [
                    {id:1, n:'Harina PAN 1kg', p:1.2, c:0.9, s:100},
                    {id:2, n:'Arroz Mary 1kg', p:1.1, c:0.8, s:80},
                    {id:3, n:'Pasta Primor', p:1.5, c:1.0, s:60},
                    {id:4, n:'Margarina Mavesa', p:2.5, c:1.8, s:40},
                    {id:5, n:'Mayonesa Kraft', p:3.8, c:2.9, s:30},
                    {id:6, n:'Salsa Tomate Heinz', p:2.2, c:1.5, s:50},
                    {id:7, n:'Azucar Montalban', p:1.6, c:1.1, s:90},
                    {id:8, n:'Cafe Fama America', p:5.0, c:3.5, s:25},
                    {id:9, n:'Atun Margarita', p:1.9, c:1.3, s:70},
                    {id:10, n:'Refresco CocaCola', p:2.8, c:2.0, s:35},
                    {id:11, n:'JabÃ³n Las Llaves', p:1.2, c:0.8, s:120},
                    {id:12, n:'Aceite Mazeite', p:3.5, c:2.6, s:45},
                    {id:13, n:'Queso Duro (Kg)', p:7.5, c:5.0, s:15},
                    {id:14, n:'Jamon Pierna (Kg)', p:9.0, c:6.5, s:10},
                    {id:15, n:'Galletas Maria', p:1.5, c:1.0, s:60}
                ];

                // Ventas HistÃ³ricas (60 dÃ­as)
                sales = [];
                fiscal = [];
                const now = new Date();

                for (let i = 60; i >= 0; i--) {
                    const date = new Date(now);
                    date.setDate(date.getDate() - i);
                    const isoDate = date.toISOString().split('T')[0];
                    
                    // 3 a 8 ventas por dÃ­a
                    const dailyCount = Math.floor(Math.random() * 6) + 3;

                    for (let j = 0; j < dailyCount; j++) {
                        const itemsCount = Math.floor(Math.random() * 4) + 1;
                        let saleTotal = 0;
                        let saleCost = 0;
                        let saleItems = [];

                        for (let k = 0; k < itemsCount; k++) {
                            const p = products[Math.floor(Math.random() * products.length)];
                            const qty = Math.floor(Math.random() * 3) + 1;
                            saleTotal += p.p * qty;
                            saleCost += p.c * qty;
                            saleItems.push({n:p.n, q:qty, t:p.p*qty});
                        }

                        // Guardar Venta
                        sales.push({
                            d: isoDate,
                            t: saleTotal,
                            c: saleCost,
                            items: saleItems
                        });

                        // Guardar Fiscal
                        fiscal.push({
                            d: isoDate,
                            fac: `000-${10000 + fiscal.length}`,
                            cli: Math.random()>0.7 ? "V-12345678" : "V-00000000",
                            nom: Math.random()>0.7 ? "Pedro Perez" : "Consumidor Final",
                            tot: saleTotal * BCV
                        });
                    }
                }

                saveData();
            } else {
                // Cargar existentes
                products = JSON.parse(localStorage.getItem(DB.prods));
                sales = JSON.parse(localStorage.getItem(DB.sales));
                fiscal = JSON.parse(localStorage.getItem(DB.fiscal));
            }
        }

        function saveData() {
            localStorage.setItem(DB.prods, JSON.stringify(products));
            localStorage.setItem(DB.sales, JSON.stringify(sales));
            localStorage.setItem(DB.fiscal, JSON.stringify(fiscal));
        }

        // --- 2. RENDERIZADO ---
        function renderAll() {
            // Dashboard
            const totalUSD = sales.reduce((a,b) => a + b.t, 0);
            const totalCost = sales.reduce((a,b) => a + b.c, 0);
            const profit = totalUSD - totalCost;
            
            document.getElementById('totalSales').innerText = `Bs. ${(totalUSD * BCV).toLocaleString('es-VE')}`;
            document.getElementById('totalProfit').innerText = `Bs. ${(profit * BCV).toLocaleString('es-VE')}`;
            document.getElementById('totalTx').innerText = sales.length;

            // GrÃ¡fico Ventas (Agrupado por dÃ­a)
            const salesByDay = {};
            sales.forEach(s => {
                if(!salesByDay[s.d]) salesByDay[s.d] = 0;
                salesByDay[s.d] += s.t;
            });
            // Tomar Ãºltimos 30 dÃ­as
            const labels = Object.keys(salesByDay).slice(-30);
            const data = Object.values(salesByDay).slice(-30).map(v => v * BCV);

            if(salesChart) salesChart.destroy();
            salesChart = new Chart(document.getElementById('salesChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ventas Diarias (Bs)',
                        data: data,
                        borderColor: '#FF6B35',
                        backgroundColor: 'rgba(255,107,53,0.1)',
                        fill: true
                    }]
                },
                options: { responsive:true, maintainAspectRatio:false }
            });

            // Tabla Inventario
            const invBody = document.querySelector('#invTable tbody');
            invBody.innerHTML = products.map(p => `
                <tr>
                    <td>${p.n}</td>
                    <td>${p.s}</td>
                    <td>$${p.c}</td>
                    <td>$${p.p}</td>
                    <td><button class="btn" style="padding:2px 5px; font-size:0.7rem" onclick="addToCartById(${p.id})">Vender</button></td>
                </tr>
            `).join('');

            // Tabla POS
            const posBody = document.querySelector('#posTable tbody');
            posBody.innerHTML = products.map(p => `
                <tr>
                    <td>${p.n}</td>
                    <td>$${p.p}</td>
                    <td><button class="badge bg-green" onclick="addToCartById(${p.id})">+</button></td>
                </tr>
            `).join('');

            // GrÃ¡fico Ganancias (Top 5 Productos)
            const prodPerf = {};
            sales.forEach(s => {
                s.items.forEach(i => {
                    if(!prodPerf[i.n]) prodPerf[i.n] = {rev:0, profit:0};
                    // Buscar costo original
                    const orig = products.find(p=>p.n === i.n);
                    const cost = orig ? orig.c : 0;
                    prodPerf[i.n].rev += i.t;
                    prodPerf[i.n].profit += (i.t - (cost * i.q));
                });
            });
            
            const sortedProds = Object.entries(prodPerf).sort((a,b) => b[1].profit - a[1].profit).slice(0,5);
            
            if(profitChart) profitChart.destroy();
            profitChart = new Chart(document.getElementById('profitChart'), {
                type: 'bar',
                data: {
                    labels: sortedProds.map(x=>x[0]),
                    datasets: [{
                        label: 'Ganancia (USD)',
                        data: sortedProds.map(x=>x[1].profit),
                        backgroundColor: '#2C3E50'
                    }]
                },
                options: { responsive:true, maintainAspectRatio:false }
            });

            // Tabla Ganancias
            document.querySelector('#profitTable tbody').innerHTML = sortedProds.map(x => `
                <tr>
                    <td>${x[0]}</td>
                    <td>-</td> <td>$${x[1].rev.toFixed(2)}</td>
                    <td style="color:green; font-weight:bold">$${x[1].profit.toFixed(2)}</td>
                </tr>
            `).join('');

            // Tabla Fiscal
            const fiscalRev = [...fiscal].reverse().slice(0, 50); // Mostrar ultimas 50
            document.querySelector('#fiscalTable tbody').innerHTML = fiscalRev.map(f => `
                <tr>
                    <td>${f.d}</td>
                    <td>${f.fac}</td>
                    <td>00-00${Math.floor(Math.random()*900)}</td>
                    <td>${f.nom}<br><small>${f.cli}</small></td>
                    <td>Bs. ${f.tot.toLocaleString('es-VE')}</td>
                </tr>
            `).join('');
        }

        // --- 3. LÃ“GICA POS ---
        function addToCartById(id) {
            const p = products.find(x => x.id === id);
            if(p) {
                cart.push(p);
                renderCart();
            }
        }

        function filterPos() {
            const term = document.getElementById('posSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#posTable tbody tr');
            rows.forEach(r => {
                const txt = r.innerText.toLowerCase();
                r.style.display = txt.includes(term) ? '' : 'none';
            });
        }

        function renderCart() {
            const tbody = document.querySelector('#cartTable tbody');
            let total = 0;
            tbody.innerHTML = cart.map((p, i) => {
                total += p.p;
                return `<tr>
                    <td>${p.n}</td>
                    <td>$${p.p}</td>
                    <td style="color:red; cursor:pointer" onclick="cart.splice(${i},1); renderCart()">x</td>
                </tr>`;
            }).join('');
            document.getElementById('cartTotal').innerText = `Bs. ${(total * BCV).toLocaleString('es-VE')}`;
        }

        function checkout() {
            if(cart.length === 0) return alert("Carrito vacÃ­o");
            
            const totalUSD = cart.reduce((a,b)=>a+b.p, 0);
            const totalCost = cart.reduce((a,b)=>a+b.c, 0);
            const today = new Date().toISOString().split('T')[0];

            // Add Sale
            sales.push({
                d: today,
                t: totalUSD,
                c: totalCost,
                items: cart.map(p => ({n:p.n, q:1, t:p.p}))
            });

            // Add Fiscal
            fiscal.push({
                d: today,
                fac: `000-${10000 + fiscal.length}`,
                cli: "Consumidor Final",
                nom: "Consumidor Final",
                tot: totalUSD * BCV
            });

            saveData();
            cart = [];
            renderCart();
            renderAll();
            alert("Venta registrada con Ã©xito!");
        }

        // --- 4. CHATBOT (GEMINI 2.5) ---
        function toggleChat() {
            const w = document.getElementById('chatWindow');
            w.style.display = w.style.display === 'flex' ? 'none' : 'flex';
        }

        async function sendMsg() {
            const input = document.getElementById('chatInput');
            const txt = input.value.trim();
            if(!txt) return;

            const body = document.getElementById('chatBody');
            body.innerHTML += `<div class="msg user">${txt}</div>`;
            input.value = '';
            input.disabled = true;

            // Contexto inteligente
            const context = `Eres asistente de Market Cris. 
            Datos actuales: 
            - Ventas mes: $${sales.reduce((a,b)=>a+b.t,0).toFixed(2)}. 
            - Ganancia neta: $${(sales.reduce((a,b)=>a+b.t,0) - sales.reduce((a,b)=>a+b.c,0)).toFixed(2)}.
            - Productos: ${products.map(p=>p.n).join(', ')}.
            Responde breve y Ãºtil para el dueÃ±o.`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: context + " Pregunta: " + txt }] }] })
                });
                const data = await res.json();
                const reply = data.candidates[0].content.parts[0].text;
                body.innerHTML += `<div class="msg bot">${reply}</div>`;
            } catch(e) {
                body.innerHTML += `<div class="msg bot" style="color:red">Error de conexiÃ³n AI.</div>`;
            }
            
            input.disabled = false;
            input.focus();
            body.scrollTop = body.scrollHeight;
        }

        // --- INIT ---
        function show(id) {
            document.querySelectorAll('.page').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active'); // Nota: esto requiere pasar el evento, simplificado aquÃ­
            // Close sidebar on mobile
            if(window.innerWidth < 1024) document.getElementById('sidebar').classList.remove('show');
        }
        function toggleMenu() { document.getElementById('sidebar').classList.toggle('show'); }

        // Boot
        initData();
        renderAll();

    </script>
</body>
</html>
